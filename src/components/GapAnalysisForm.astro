---
// GapAnalysisForm - Simplified form with smart defaults and advanced options
import Tooltip from './Tooltip.astro';
---

<form class="gap-form" id="gap-analysis-form" novalidate>
  <!-- Main Form Section -->
  <div class="form-main">
    <!-- Topic Input -->
    <div class="form-group topic-group">
      <div class="label-row">
        <label for="gap-topic" class="form-label">Research Topic</label>
        <Tooltip content="Enter your research area using natural language. Example: 'machine learning in healthcare' or 'sustainable energy storage'" position="right" />
      </div>
      <div class="input-wrapper">
        <input
          type="text"
          id="gap-topic"
          name="topic"
          placeholder="e.g., Machine learning in medical diagnosis"
          required
          minlength="5"
          maxlength="200"
          class="form-input topic-input"
          autocomplete="off"
        />
        <div class="input-accent"></div>
      </div>
      <div class="input-footer">
        <span class="form-hint">Enter your research area to analyze for gaps</span>
        <span class="char-count" id="char-count">0/200</span>
      </div>
      <span class="form-error" id="topic-error"></span>
    </div>

    <!-- Analysis Depth -->
    <div class="form-group depth-group">
      <div class="label-row">
        <label class="form-label">Analysis Depth</label>
        <Tooltip content="Quick: ~1-2 min, analyzes metadata. Deep: ~5-8 min, includes full-text analysis when available." position="right" />
      </div>
      <div class="depth-toggle">
        <label class="depth-option">
          <input type="radio" name="depth" value="quick" checked />
          <span class="depth-content">
            <span class="depth-header">
              <span class="depth-icon">›</span>
              <span class="depth-label">Quick</span>
            </span>
            <span class="depth-desc">Metadata analysis, best for exploration</span>
          </span>
        </label>
        <label class="depth-option">
          <input type="radio" name="depth" value="deep" />
          <span class="depth-content">
            <span class="depth-header">
              <span class="depth-icon">◆</span>
              <span class="depth-label">Deep</span>
            </span>
            <span class="depth-desc">Full-text analysis, comprehensive insights</span>
          </span>
        </label>
      </div>
    </div>
  </div>

  <!-- Advanced Options (Collapsible) -->
  <div class="advanced-section" id="advanced-section">
    <button type="button" class="advanced-toggle" id="advanced-toggle" aria-expanded="false">
      <span class="toggle-text">Advanced Options</span>
      <span class="toggle-icon">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span>
    </button>

    <div class="advanced-content" id="advanced-content">
      <div class="advanced-inner">
        <!-- Analysis Types -->
        <div class="form-group types-group">
          <div class="label-row">
            <label class="form-label">Analysis Types</label>
            <Tooltip content="Select which types of analysis to perform. All enabled by default for comprehensive results." position="top" />
          </div>
          <div class="checkbox-row">
            <label class="checkbox-item">
              <input type="checkbox" name="analysisTypes" value="gaps" checked />
              <span class="checkbox-box">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M2.5 6L5 8.5L9.5 3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <span class="checkbox-label">
                <span class="checkbox-title">Gap Detection</span>
                <Tooltip content="Identifies under-researched areas, temporal gaps, and methodological gaps in the literature." position="top" />
              </span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="analysisTypes" value="comparisons" checked />
              <span class="checkbox-box">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M2.5 6L5 8.5L9.5 3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <span class="checkbox-label">
                <span class="checkbox-title">Methodology Compare</span>
                <Tooltip content="Analyzes how different papers approach similar problems and highlights contradictions." position="top" />
              </span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" name="analysisTypes" value="directions" checked />
              <span class="checkbox-box">
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M2.5 6L5 8.5L9.5 3.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </span>
              <span class="checkbox-label">
                <span class="checkbox-title">Research Directions</span>
                <Tooltip content="AI generates novel research opportunities based on identified gaps and trends." position="top" />
              </span>
            </label>
          </div>
          <span class="form-error" id="types-error"></span>
        </div>

        <!-- Papers & Year Row -->
        <div class="form-row">
          <div class="form-group papers-group">
            <div class="label-row">
              <label for="gap-papers" class="form-label">Papers to Analyze</label>
              <Tooltip content="10-100 papers. More papers = comprehensive analysis but longer processing time. 30 is a good balance." position="top" />
            </div>
            <div class="stepper-input">
              <button type="button" class="stepper-btn minus" data-action="decrease" aria-label="Decrease">−</button>
              <input
                type="number"
                id="gap-papers"
                name="papers"
                value="30"
                min="10"
                max="100"
                step="10"
                class="stepper-value"
              />
              <button type="button" class="stepper-btn plus" data-action="increase" aria-label="Increase">+</button>
            </div>
          </div>

          <div class="form-group year-group">
            <div class="label-row">
              <label for="gap-year" class="form-label">Year Filter</label>
              <Tooltip content="Limit analysis to specific years (e.g., '2020-2024'). Leave empty to analyze all available papers." position="top" />
            </div>
            <input
              type="text"
              id="gap-year"
              name="yearFilter"
              placeholder="e.g., 2020-2024"
              pattern="[0-9]{4}-[0-9]{4}"
              class="form-input year-input"
            />
            <span class="form-error" id="year-error"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Submit Section -->
  <div class="form-actions">
    <div class="time-estimate" id="time-estimate">
      <span class="estimate-icon">⏱</span>
      <span class="estimate-text">Estimated time: <strong id="estimate-value">~1-2 minutes</strong></span>
    </div>
    <button type="submit" class="submit-btn" id="gap-submit-btn">
      <span class="btn-text">Start Analysis</span>
      <span class="btn-icon">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M4 10h12M12 6l4 4-4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </span>
      <span class="btn-loader"></span>
    </button>
  </div>
</form>

<style>
  .gap-form {
    width: 100%;
  }

  .form-main {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Label Row */
  .label-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .form-label {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-gap-text-secondary);
    margin: 0;
  }

  .form-hint {
    font-size: 0.8125rem;
    color: var(--color-gap-text-secondary);
    opacity: 0.7;
  }

  .form-error {
    display: none;
    font-size: 0.8125rem;
    color: var(--color-error);
    margin-top: 0.375rem;
  }

  .form-error.visible {
    display: block;
  }

  /* Topic Input */
  .input-wrapper {
    position: relative;
  }

  .topic-input {
    width: 100%;
    padding: 1rem 1.25rem;
    font-size: 1.125rem;
    background: var(--color-gap-surface);
    border: 2px solid var(--color-gap-border);
    border-radius: var(--radius-lg);
    color: var(--color-gap-text);
    transition: all 0.2s ease;
  }

  .topic-input:focus {
    border-color: var(--color-gap-accent);
    box-shadow: 0 0 0 4px rgba(43, 90, 74, 0.1);
    outline: none;
  }

  .topic-input.invalid {
    border-color: var(--color-error);
  }

  .topic-input.invalid:focus {
    box-shadow: 0 0 0 4px rgba(155, 68, 68, 0.1);
  }

  .topic-input::placeholder {
    color: var(--color-gap-text-secondary);
    opacity: 0.5;
  }

  .input-accent {
    position: absolute;
    bottom: 0;
    left: 1rem;
    right: 1rem;
    height: 2px;
    background: linear-gradient(90deg, var(--color-gap-accent), var(--color-gap-accent-light));
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
  }

  .topic-input:focus + .input-accent {
    transform: scaleX(1);
  }

  .input-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.375rem;
  }

  .char-count {
    font-size: 0.75rem;
    color: var(--color-gap-text-muted);
    font-variant-numeric: tabular-nums;
  }

  /* Depth Toggle */
  .depth-toggle {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }

  @media (max-width: 480px) {
    .depth-toggle {
      grid-template-columns: 1fr;
    }
  }

  .depth-option {
    cursor: pointer;
  }

  .depth-option input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .depth-content {
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    padding: 1rem 1.25rem;
    background: var(--color-gap-surface);
    border: 2px solid var(--color-gap-border);
    border-radius: var(--radius-lg);
    transition: all 0.2s ease;
  }

  .depth-option input:checked + .depth-content {
    border-color: var(--color-gap-accent);
    background: rgba(43, 90, 74, 0.05);
  }

  .depth-option:hover .depth-content {
    border-color: var(--color-gap-accent-light);
  }

  .depth-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .depth-icon {
    font-size: 1rem;
  }

  .depth-label {
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-gap-text);
  }

  .depth-desc {
    font-size: 0.8125rem;
    color: var(--color-gap-text-secondary);
  }

  /* Advanced Section */
  .advanced-section {
    margin-top: 1.5rem;
    border-top: 1px solid var(--color-gap-border);
    padding-top: 1rem;
  }

  .advanced-toggle {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 0.75rem 0;
    background: none;
    border: none;
    cursor: pointer;
    font-family: var(--font-body);
  }

  .toggle-text {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-gap-text-secondary);
    transition: color 0.2s ease;
  }

  .advanced-toggle:hover .toggle-text {
    color: var(--color-gap-accent);
  }

  .toggle-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    color: var(--color-gap-text-muted);
    transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .advanced-section.expanded .toggle-icon {
    transform: rotate(180deg);
  }

  .advanced-content {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.35s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .advanced-section.expanded .advanced-content {
    grid-template-rows: 1fr;
  }

  .advanced-inner {
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    padding-top: 0.5rem;
  }

  /* Checkbox Row */
  .checkbox-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
  }

  @media (max-width: 600px) {
    .checkbox-row {
      grid-template-columns: 1fr;
    }
  }

  .checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    padding: 0.75rem 1rem;
    background: var(--color-gap-surface);
    border: 2px solid var(--color-gap-border);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
  }

  .checkbox-item:hover {
    border-color: var(--color-gap-accent-light);
  }

  .checkbox-item:has(input:checked) {
    border-color: var(--color-gap-accent);
    background: rgba(43, 90, 74, 0.05);
  }

  .checkbox-item input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .checkbox-box {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    background: var(--color-gap-surface);
    border: 2px solid var(--color-gap-border);
    border-radius: 4px;
    transition: all 0.2s ease;
    color: transparent;
    flex-shrink: 0;
  }

  .checkbox-item input:checked + .checkbox-box {
    background: var(--color-gap-accent);
    border-color: var(--color-gap-accent);
    color: white;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .checkbox-title {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-gap-text);
  }

  /* Form Row */
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
  }

  @media (max-width: 480px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  /* Stepper Input */
  .stepper-input {
    display: flex;
    align-items: center;
    background: var(--color-gap-surface);
    border: 2px solid var(--color-gap-border);
    border-radius: var(--radius-md);
    overflow: hidden;
    height: 44px;
  }

  .stepper-btn {
    width: 40px;
    height: 100%;
    background: none;
    border: none;
    font-size: 1.125rem;
    color: var(--color-gap-text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .stepper-btn:hover {
    background: var(--color-gap-bg-deep);
    color: var(--color-gap-accent);
  }

  .stepper-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .stepper-value {
    flex: 1;
    height: 100%;
    text-align: center;
    border: none;
    background: transparent;
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--color-gap-text);
    -moz-appearance: textfield;
    font-family: var(--font-body);
  }

  .stepper-value::-webkit-outer-spin-button,
  .stepper-value::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  /* Year Input */
  .year-input {
    width: 100%;
    height: 44px;
    padding: 0 1rem;
    background: var(--color-gap-surface);
    border: 2px solid var(--color-gap-border);
    border-radius: var(--radius-md);
    font-size: 0.9375rem;
    color: var(--color-gap-text);
    transition: all 0.2s ease;
  }

  .year-input:focus {
    border-color: var(--color-gap-accent);
    outline: none;
  }

  .year-input.invalid {
    border-color: var(--color-error);
  }

  /* Form Actions */
  .form-actions {
    margin-top: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }

  .time-estimate {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-gap-text-secondary);
  }

  .estimate-icon {
    font-size: 1rem;
  }

  .estimate-text strong {
    color: var(--color-gap-accent);
    font-weight: 500;
  }

  .submit-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 1rem 2.5rem;
    background: var(--color-gap-accent);
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    font-family: var(--font-body);
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    min-width: 200px;
  }

  .submit-btn:hover:not(:disabled) {
    background: var(--color-gap-accent-dark);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(43, 90, 74, 0.3);
  }

  .submit-btn:active:not(:disabled) {
    transform: translateY(0);
  }

  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .btn-icon {
    transition: transform 0.2s ease;
  }

  .submit-btn:hover:not(:disabled) .btn-icon {
    transform: translateX(4px);
  }

  .btn-loader {
    display: none;
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  .submit-btn.loading .btn-text,
  .submit-btn.loading .btn-icon {
    display: none;
  }

  .submit-btn.loading .btn-loader {
    display: block;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  const form = document.getElementById('gap-analysis-form') as HTMLFormElement;
  const topicInput = document.getElementById('gap-topic') as HTMLInputElement;
  const papersInput = document.getElementById('gap-papers') as HTMLInputElement;
  const yearInput = document.getElementById('gap-year') as HTMLInputElement;
  const submitBtn = document.getElementById('gap-submit-btn') as HTMLButtonElement;
  const advancedSection = document.getElementById('advanced-section');
  const advancedToggle = document.getElementById('advanced-toggle');
  const charCount = document.getElementById('char-count');
  const estimateValue = document.getElementById('estimate-value');

  // Character count
  topicInput?.addEventListener('input', () => {
    const count = topicInput.value.length;
    if (charCount) charCount.textContent = `${count}/200`;
    validateTopic();
    updateTimeEstimate();
  });

  // Advanced toggle
  advancedToggle?.addEventListener('click', () => {
    const isExpanded = advancedSection?.classList.toggle('expanded');
    advancedToggle.setAttribute('aria-expanded', String(isExpanded));
  });

  // Stepper buttons
  document.querySelectorAll('.stepper-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const input = btn.parentElement?.querySelector('input') as HTMLInputElement;
      if (!input) return;

      const action = btn.getAttribute('data-action');
      const min = parseInt(input.min) || 10;
      const max = parseInt(input.max) || 100;
      const step = parseInt(input.step) || 10;
      let value = parseInt(input.value) || 30;

      if (action === 'increase' && value < max) {
        value += step;
      } else if (action === 'decrease' && value > min) {
        value -= step;
      }

      input.value = value.toString();
      updateStepperButtons();
      updateTimeEstimate();
    });
  });

  function updateStepperButtons() {
    const value = parseInt(papersInput?.value) || 30;
    const minusBtn = document.querySelector('.stepper-btn.minus') as HTMLButtonElement;
    const plusBtn = document.querySelector('.stepper-btn.plus') as HTMLButtonElement;

    if (minusBtn) minusBtn.disabled = value <= 10;
    if (plusBtn) plusBtn.disabled = value >= 100;
  }

  // Depth change updates estimate
  document.querySelectorAll('input[name="depth"]').forEach(radio => {
    radio.addEventListener('change', updateTimeEstimate);
  });

  // Time estimation
  function updateTimeEstimate() {
    const papers = parseInt(papersInput?.value) || 30;
    const depth = (document.querySelector('input[name="depth"]:checked') as HTMLInputElement)?.value || 'quick';

    const baseTime = depth === 'quick' ? 1.5 : 6;
    const estimate = Math.ceil(baseTime * (papers / 30));

    let text = '';
    if (estimate <= 2) text = '~1-2 minutes';
    else if (estimate <= 4) text = '~3-4 minutes';
    else if (estimate <= 6) text = '~5-6 minutes';
    else text = `~${estimate - 1}-${estimate + 1} minutes`;

    if (estimateValue) estimateValue.textContent = text;
  }

  // Validation functions
  function validateTopic(): boolean {
    const value = topicInput?.value.trim() || '';
    const errorEl = document.getElementById('topic-error');

    if (value.length === 0) {
      showError(topicInput, errorEl, 'Please enter a research topic');
      return false;
    }
    if (value.length < 5) {
      showError(topicInput, errorEl, 'Topic must be at least 5 characters');
      return false;
    }
    if (value.length > 200) {
      showError(topicInput, errorEl, 'Topic must be less than 200 characters');
      return false;
    }

    hideError(topicInput, errorEl);
    return true;
  }

  function validateYear(): boolean {
    const value = yearInput?.value.trim() || '';
    const errorEl = document.getElementById('year-error');

    if (!value) {
      hideError(yearInput, errorEl);
      return true; // Optional field
    }

    const pattern = /^(\d{4})-(\d{4})$/;
    const match = value.match(pattern);

    if (!match) {
      showError(yearInput, errorEl, 'Use format: YYYY-YYYY (e.g., 2020-2024)');
      return false;
    }

    const startYear = parseInt(match[1]);
    const endYear = parseInt(match[2]);

    if (endYear < startYear) {
      showError(yearInput, errorEl, 'End year must be after start year');
      return false;
    }

    if (startYear < 1900 || endYear > new Date().getFullYear() + 1) {
      showError(yearInput, errorEl, 'Please enter valid years');
      return false;
    }

    hideError(yearInput, errorEl);
    return true;
  }

  function validateTypes(): boolean {
    const checked = document.querySelectorAll('input[name="analysisTypes"]:checked');
    const errorEl = document.getElementById('types-error');

    if (checked.length === 0) {
      if (errorEl) {
        errorEl.textContent = 'Select at least one analysis type';
        errorEl.classList.add('visible');
      }
      return false;
    }

    if (errorEl) errorEl.classList.remove('visible');
    return true;
  }

  function showError(input: HTMLInputElement | null, errorEl: HTMLElement | null, message: string) {
    input?.classList.add('invalid');
    if (errorEl) {
      errorEl.textContent = message;
      errorEl.classList.add('visible');
    }
  }

  function hideError(input: HTMLInputElement | null, errorEl: HTMLElement | null) {
    input?.classList.remove('invalid');
    if (errorEl) errorEl.classList.remove('visible');
  }

  // Form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Validate all fields
    const isTopicValid = validateTopic();
    const isYearValid = validateYear();
    const isTypesValid = validateTypes();

    if (!isTopicValid || !isYearValid || !isTypesValid) {
      return;
    }

    // Get form data
    const formData = new FormData(form);
    const topic = formData.get('topic') as string;
    const papers = parseInt(formData.get('papers') as string) || 30;
    const depth = formData.get('depth') as string || 'quick';
    const yearFilter = formData.get('yearFilter') as string;

    // Get analysis types
    const analysisTypes: string[] = [];
    formData.getAll('analysisTypes').forEach(type => {
      analysisTypes.push(type as string);
    });

    if (analysisTypes.length === 0) {
      analysisTypes.push('gaps', 'comparisons', 'directions');
    }

    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.classList.add('loading');

    try {
      const response = await fetch('/api/analyze-gaps', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          topic,
          analysisTypes,
          papers,
          yearFilter: yearFilter || undefined,
          depth
        })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Analysis failed');
      }

      // Dispatch event with task ID for progress tracking
      window.dispatchEvent(new CustomEvent('gapAnalysisStarted', {
        detail: { taskId: data.taskId, topic }
      }));

    } catch (error) {
      console.error('Gap analysis error:', error);
      showError(null, document.getElementById('topic-error'), error instanceof Error ? error.message : 'Analysis failed. Please try again.');
      submitBtn.disabled = false;
      submitBtn.classList.remove('loading');
    }
  });

  // Initial setup
  updateStepperButtons();
  updateTimeEstimate();
</script>
