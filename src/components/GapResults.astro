---
// GapResults - Enhanced results display with prioritization, filtering, and refine workflow
---

<div class="gap-results-container" id="gap-results-container">
  <!-- Loading Overlay -->
  <div id="gap-results-loading" class="gap-results-loading" style="display: none;">
    <span class="spinner spinner-lg"></span>
    <span>Loading results...</span>
  </div>

  <div class="results-header">
    <div class="results-title-section">
      <h1 class="results-title">Analysis Complete</h1>
      <p class="results-topic" id="results-topic"></p>
    </div>
    <div class="results-actions">
      <button class="action-btn secondary-btn" id="refine-btn" type="button">
        <span class="btn-icon">↻</span>
        <span class="btn-text">Refine</span>
      </button>
      <button class="action-btn primary-btn" id="download-report-btn" type="button">
        <span class="btn-icon">↓</span>
        <span class="btn-text">Download Report</span>
      </button>
      <button class="action-btn text-btn" id="new-analysis-btn" type="button">
        New Analysis
      </button>
    </div>
  </div>

  <!-- Results Summary -->
  <div class="results-summary" id="results-summary">
    <div class="summary-stat">
      <span class="summary-value" id="summary-papers">0</span>
      <span class="summary-label">Papers Analyzed</span>
    </div>
    <div class="summary-divider"></div>
    <div class="summary-stat">
      <span class="summary-value" id="summary-gaps">0</span>
      <span class="summary-label">Gaps Found</span>
    </div>
    <div class="summary-divider"></div>
    <div class="summary-stat">
      <span class="summary-value" id="summary-directions">0</span>
      <span class="summary-label">Research Directions</span>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tabs-nav">
    <button class="tab-btn active" data-tab="gaps">
      <span class="tab-icon">◇</span>
      <span class="tab-label">Research Gaps</span>
      <span class="tab-count" id="tab-gaps-count">0</span>
    </button>
    <button class="tab-btn" data-tab="comparisons">
      <span class="tab-icon">◆</span>
      <span class="tab-label">Comparisons</span>
      <span class="tab-count" id="tab-comparisons-count">0</span>
    </button>
    <button class="tab-btn" data-tab="directions">
      <span class="tab-icon">◈</span>
      <span class="tab-label">Directions</span>
      <span class="tab-count" id="tab-directions-count">0</span>
    </button>
    <button class="tab-btn" data-tab="trends">
      <span class="tab-icon">↗</span>
      <span class="tab-label">Trends</span>
    </button>
  </div>

  <!-- Filter Bar (for gaps tab) -->
  <div class="filter-bar" id="filter-bar">
    <div class="filter-group">
      <label class="filter-label">Severity</label>
      <select class="filter-select" id="filter-severity">
        <option value="all">All</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">Sort by</label>
      <select class="filter-select" id="filter-sort">
        <option value="priority">Priority</option>
        <option value="severity">Severity</option>
        <option value="alphabetical">Alphabetical</option>
      </select>
    </div>
    <span class="filter-count" id="filter-count">Showing all</span>
  </div>

  <!-- Tab Content -->
  <div class="tabs-content">
    <!-- Gaps Tab -->
    <div class="tab-panel active" id="tab-gaps">
      <div class="gaps-list" id="gaps-list">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Comparisons Tab -->
    <div class="tab-panel" id="tab-comparisons">
      <div class="comparisons-list" id="comparisons-list">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Directions Tab -->
    <div class="tab-panel" id="tab-directions">
      <div class="directions-list" id="directions-list">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Trends Tab -->
    <div class="tab-panel" id="tab-trends">
      <div class="trends-content" id="trends-content">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>
</div>

<!-- Refine Modal -->
<div class="refine-modal" id="refine-modal">
  <div class="refine-backdrop" id="refine-backdrop"></div>
  <div class="refine-dialog">
    <div class="refine-header">
      <h2 class="refine-title">Refine Analysis</h2>
      <button class="refine-close" id="refine-close" type="button">×</button>
    </div>
    <div class="refine-body">
      <p class="refine-desc">Adjust parameters and run additional analysis on the same topic.</p>
      <div class="refine-current">
        <span class="current-label">Current:</span>
        <span class="current-value" id="current-params"></span>
      </div>
      <div class="refine-options">
        <label class="refine-option">
          <input type="checkbox" id="refine-more-papers" />
          <div class="option-content">
            <span class="option-text">Analyze more papers</span>
            <span class="option-hint">Add 20 additional papers to the analysis</span>
          </div>
        </label>
        <label class="refine-option">
          <input type="checkbox" id="refine-deep" />
          <div class="option-content">
            <span class="option-text">Deep analysis</span>
            <span class="option-hint">More thorough gap detection (slower)</span>
          </div>
        </label>
        <div class="refine-option-wrapper">
          <label class="refine-option">
            <input type="checkbox" id="refine-year" />
            <div class="option-content">
              <span class="option-text">Year filter</span>
              <span class="option-hint">Limit papers to a specific range</span>
            </div>
          </label>
          <input type="text" class="refine-year-input" id="refine-year-input" placeholder="e.g. 2020-2024" disabled />
        </div>
      </div>
    </div>
    <div class="refine-footer">
      <button class="action-btn secondary-btn" id="refine-cancel" type="button">Cancel</button>
      <button class="action-btn primary-btn" id="refine-submit" type="button">
        <span class="btn-text">Refine Analysis</span>
        <span class="btn-icon">→</span>
      </button>
    </div>
  </div>
</div>

<style is:global>
  .gap-results-container {
    display: none;
    flex-direction: column;
    padding: 1.5rem 0;
    position: relative;
  }

  .gap-results-container.active {
    display: flex;
    animation: fadeIn 0.5s ease;
  }

  /* Loading Overlay */
  .gap-results-loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);
    background: rgba(245, 247, 245, 0.95);
    z-index: 10;
    color: var(--color-gap-text-secondary);
    min-height: 300px;
  }

  .gap-results-loading .spinner {
    color: var(--color-gap-accent);
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Header */
  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .results-title-section {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .results-title {
    font-family: var(--font-display);
    font-size: 1.75rem;
    color: var(--color-gap-text);
    margin: 0;
  }

  .results-topic {
    font-size: 0.9375rem;
    color: var(--color-gap-text-secondary);
    margin: 0;
  }

  .results-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .action-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1rem;
    border-radius: var(--radius-md);
    font-family: var(--font-body);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
  }

  .primary-btn {
    background: var(--color-gap-accent);
    color: white;
  }

  .primary-btn:hover {
    background: var(--color-gap-accent-dark);
    transform: translateY(-1px);
  }

  .secondary-btn {
    background: var(--color-gap-surface);
    color: var(--color-gap-text);
    border: 1px solid var(--color-gap-border);
  }

  .secondary-btn:hover {
    border-color: var(--color-gap-accent);
    color: var(--color-gap-accent);
  }

  .text-btn {
    background: none;
    color: var(--color-gap-text-secondary);
    padding: 0.625rem 0.5rem;
  }

  .text-btn:hover {
    color: var(--color-gap-accent);
  }

  /* Summary - Clean minimal */
  .results-summary {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-xl);
    padding: var(--space-lg) var(--space-xl);
    margin-bottom: var(--space-lg);
  }

  .summary-stat {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }

  .summary-value {
    font-family: var(--font-display);
    font-size: 1.75rem;
    color: var(--color-gap-accent);
    line-height: 1;
  }

  .summary-label {
    font-size: 0.6875rem;
    color: var(--color-gap-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .summary-divider {
    width: 1px;
    height: 36px;
    background: var(--color-gap-border);
  }

  /* Tabs - Minimal underline style */
  .tabs-nav {
    display: flex;
    gap: var(--space-lg);
    margin-bottom: var(--space-lg);
    border-bottom: 1px solid var(--color-gap-border);
    overflow-x: auto;
  }

  .tab-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: var(--space-sm) 0;
    padding-bottom: var(--space-md);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
    font-family: var(--font-body);
    font-size: 0.9375rem;
    color: var(--color-gap-text-muted);
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .tab-btn:hover {
    color: var(--color-gap-text);
  }

  .tab-btn.active {
    color: var(--color-gap-accent);
    border-bottom-color: var(--color-gap-accent);
  }

  .tab-icon {
    font-size: 1rem;
    opacity: 0.7;
  }

  .tab-btn.active .tab-icon {
    opacity: 1;
  }

  .tab-label {
    display: none;
  }

  .tab-count {
    font-size: 0.8125rem;
    font-weight: 500;
  }

  @media (min-width: 640px) {
    .tab-label {
      display: inline;
    }
  }

  /* Filter Bar */
  .filter-bar {
    display: none;
    align-items: center;
    gap: 1.25rem;
    padding: 0.875rem 1.25rem;
    background: var(--color-gap-surface);
    border: 1px solid var(--color-gap-border);
    border-radius: var(--radius-md);
    margin-bottom: 1rem;
  }

  .filter-bar.visible {
    display: flex;
  }

  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.625rem;
  }

  .filter-label {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-gap-text-muted);
  }

  .filter-select {
    appearance: none;
    -webkit-appearance: none;
    padding: 0.5rem 2rem 0.5rem 0.875rem;
    background: var(--color-gap-bg);
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%232b5a4a' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.625rem center;
    border: 1px solid var(--color-gap-border);
    border-radius: var(--radius-md);
    font-family: var(--font-body);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-gap-text);
    cursor: pointer;
    transition: all 0.2s ease;
    min-width: 100px;
  }

  .filter-select:hover {
    border-color: var(--color-gap-accent-light);
  }

  .filter-select:focus {
    outline: none;
    border-color: var(--color-gap-accent);
    box-shadow: 0 0 0 3px rgba(43, 90, 74, 0.1);
  }

  .filter-count {
    margin-left: auto;
    font-size: 0.8125rem;
    color: var(--color-gap-text-muted);
  }

  /* Tab Content */
  .tabs-content {
    width: 100%;
  }

  .tab-panel {
    display: none;
  }

  .tab-panel.active {
    display: block;
    animation: tabFadeIn 0.3s ease;
  }

  @keyframes tabFadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Gap Card - Clean minimal style */
  .gaps-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .gap-card {
    background: var(--color-gap-surface);
    border-radius: var(--radius-lg);
    padding: var(--space-md) var(--space-lg);
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(20, 26, 24, 0.04);
    border-left: 3px solid var(--color-gap-accent-light);
  }

  .gap-card:hover {
    box-shadow: 0 4px 12px rgba(43, 90, 74, 0.08);
    border-left-color: var(--color-gap-accent);
  }

  .gap-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--space-sm);
    gap: var(--space-md);
  }

  .gap-title-row {
    display: flex;
    align-items: baseline;
    gap: var(--space-sm);
  }

  .gap-number {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-gap-text-muted);
  }

  .gap-title {
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-gap-text);
    margin: 0;
    line-height: 1.4;
  }

  /* Severity dot instead of badges */
  .severity-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 6px;
  }

  .severity-dot.high {
    background: var(--color-error);
  }

  .severity-dot.medium {
    background: var(--color-warning);
  }

  .severity-dot.low {
    background: var(--color-gap-accent-light);
  }

  .gap-badges {
    display: flex;
    gap: 0.375rem;
    flex-shrink: 0;
  }

  .gap-badge {
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .badge-type {
    background: rgba(43, 90, 74, 0.1);
    color: var(--color-gap-accent);
  }

  .badge-severity {
    background: rgba(166, 139, 61, 0.1);
    color: var(--color-warning);
  }

  .badge-severity.high {
    background: rgba(155, 68, 68, 0.1);
    color: var(--color-error);
  }

  .badge-severity.low {
    background: rgba(74, 124, 89, 0.1);
    color: var(--color-success);
  }

  .gap-description {
    font-size: 0.9375rem;
    color: var(--color-gap-text-secondary);
    line-height: 1.6;
    margin: 0;
  }

  /* Collapsible approach toggle */
  .gap-approach-toggle {
    display: inline-flex;
    align-items: center;
    margin-top: var(--space-sm);
    padding: 0;
    background: none;
    border: none;
    font-family: var(--font-body);
    font-size: 0.8125rem;
    color: var(--color-gap-accent);
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .gap-approach-toggle:hover {
    color: var(--color-gap-accent-dark);
  }

  .gap-approach-toggle::before {
    content: '▸';
    margin-right: 0.375rem;
    transition: transform 0.2s ease;
  }

  .gap-approach {
    margin-top: var(--space-sm);
    padding: var(--space-md);
    background: var(--color-gap-bg);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    color: var(--color-gap-text-secondary);
    line-height: 1.6;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
  }

  .gap-approach.collapsed {
    max-height: 0;
    padding-top: 0;
    padding-bottom: 0;
    opacity: 0;
  }

  /* Direction Card */
  .direction-card {
    background: var(--color-gap-surface);
    border-radius: var(--radius-lg);
    padding: var(--space-md) var(--space-lg);
    margin-bottom: var(--space-md);
    box-shadow: 0 1px 3px rgba(20, 26, 24, 0.04);
    border-left: 3px solid var(--color-gap-accent-light);
    transition: all 0.2s ease;
  }

  .direction-card:hover {
    box-shadow: 0 4px 12px rgba(43, 90, 74, 0.08);
    border-left-color: var(--color-gap-accent);
  }

  .direction-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.625rem;
    gap: 1rem;
  }

  .direction-title {
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-gap-text);
    margin: 0;
  }

  .direction-ratings {
    display: flex;
    gap: 0.625rem;
  }

  .rating {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.125rem;
  }

  .rating-label {
    font-size: 0.5625rem;
    text-transform: uppercase;
    color: var(--color-gap-text-muted);
  }

  .rating-value {
    font-size: 0.6875rem;
    font-weight: 600;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
  }

  .rating-value.high {
    background: rgba(74, 124, 89, 0.15);
    color: var(--color-success);
  }

  .rating-value.medium {
    background: rgba(166, 139, 61, 0.15);
    color: var(--color-warning);
  }

  .rating-value.low {
    background: rgba(155, 68, 68, 0.1);
    color: var(--color-error);
  }

  .direction-description {
    font-size: 0.9375rem;
    color: var(--color-gap-text-secondary);
    line-height: 1.6;
    margin: 0 0 0.625rem;
  }

  .direction-rationale {
    font-size: 0.8125rem;
    color: var(--color-gap-text-muted);
    font-style: italic;
    padding-left: 0.875rem;
    border-left: 2px solid var(--color-gap-border);
  }

  /* Comparison Card */
  .comparison-card {
    background: var(--color-gap-surface);
    border-radius: var(--radius-lg);
    padding: var(--space-md) var(--space-lg);
    margin-bottom: var(--space-md);
    box-shadow: 0 1px 3px rgba(20, 26, 24, 0.04);
    border-left: 3px solid var(--color-gap-accent-light);
    transition: all 0.2s ease;
  }

  .comparison-card:hover {
    box-shadow: 0 4px 12px rgba(43, 90, 74, 0.08);
    border-left-color: var(--color-gap-accent);
  }

  .comparison-dimension {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--color-gap-accent);
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-xs);
    border-bottom: 1px solid var(--color-gap-border);
  }

  .comparison-findings {
    display: flex;
    flex-direction: column;
    gap: 0.875rem;
  }

  .finding-group {
    padding: 0.875rem;
    background: var(--color-gap-bg);
    border-radius: var(--radius-md);
  }

  .finding-label {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--color-gap-text-secondary);
    margin-bottom: 0.5rem;
  }

  .finding-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .finding-list li {
    font-size: 0.875rem;
    color: var(--color-gap-text-secondary);
    padding: 0.25rem 0 0.25rem 1rem;
    position: relative;
  }

  .finding-list li::before {
    content: '•';
    position: absolute;
    left: 0;
    color: var(--color-gap-accent);
  }

  /* Trends Content */
  .trends-content {
    display: grid;
    gap: var(--space-md);
  }

  .trend-card {
    background: var(--color-gap-surface);
    border-radius: var(--radius-lg);
    padding: var(--space-md) var(--space-lg);
    box-shadow: 0 1px 3px rgba(20, 26, 24, 0.04);
    border-left: 3px solid var(--color-gap-accent-light);
    transition: all 0.2s ease;
  }

  .trend-card:hover {
    box-shadow: 0 4px 12px rgba(43, 90, 74, 0.08);
    border-left-color: var(--color-gap-accent);
  }

  .trend-title {
    font-size: 0.8125rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-gap-text-secondary);
    margin: 0 0 var(--space-sm);
  }

  .trend-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.625rem 0.5rem;
  }

  .trend-tag {
    font-size: 0.8125rem;
    padding: 0.375rem 0.875rem;
    background: rgba(43, 90, 74, 0.1);
    color: var(--color-gap-accent);
    border-radius: 100px;
    white-space: nowrap;
    transition: all 0.2s ease;
  }

  .trend-tag:hover {
    background: rgba(43, 90, 74, 0.15);
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem 1.5rem;
  }

  .empty-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    opacity: 0.4;
  }

  .empty-title {
    font-family: var(--font-display);
    font-size: 1.125rem;
    color: var(--color-gap-text);
    margin: 0 0 0.5rem;
  }

  .empty-desc {
    font-size: 0.9375rem;
    color: var(--color-gap-text-secondary);
    margin: 0 0 1rem;
    max-width: 360px;
    margin-left: auto;
    margin-right: auto;
  }

  .empty-suggestions {
    list-style: none;
    padding: 0;
    margin: 0 0 1.5rem;
    text-align: left;
    display: inline-block;
  }

  .empty-suggestions li {
    font-size: 0.875rem;
    color: var(--color-gap-text-muted);
    padding: 0.25rem 0;
    padding-left: 1.25rem;
    position: relative;
  }

  .empty-suggestions li::before {
    content: '→';
    position: absolute;
    left: 0;
    color: var(--color-gap-accent);
  }

  .empty-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: var(--color-gap-accent);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-family: var(--font-body);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .empty-btn:hover {
    background: var(--color-gap-accent-dark);
    transform: translateY(-1px);
  }

  /* Refine Modal */
  .refine-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .refine-modal.active {
    display: flex;
    animation: modalFadeIn 0.2s ease;
  }

  @keyframes modalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .refine-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(20, 26, 24, 0.6);
    backdrop-filter: blur(4px);
  }

  .refine-dialog {
    position: relative;
    width: 100%;
    max-width: 440px;
    background: var(--color-gap-surface);
    border-radius: var(--radius-lg);
    box-shadow: 0 24px 48px rgba(20, 26, 24, 0.2);
    animation: dialogSlideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  @keyframes dialogSlideIn {
    from { opacity: 0; transform: translateY(20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  .refine-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--color-gap-border);
  }

  .refine-title {
    font-family: var(--font-display);
    font-size: 1.25rem;
    color: var(--color-gap-text);
    margin: 0;
  }

  .refine-close {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--color-gap-text-muted);
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s ease;
  }

  .refine-close:hover {
    background: var(--color-gap-bg-deep);
    color: var(--color-gap-text);
  }

  .refine-body {
    padding: 1.5rem;
  }

  .refine-desc {
    font-size: 0.9375rem;
    color: var(--color-gap-text-secondary);
    margin: 0 0 1rem;
  }

  .refine-current {
    padding: 0.75rem 1rem;
    background: var(--color-gap-bg);
    border-radius: var(--radius-md);
    margin-bottom: 1.25rem;
    font-size: 0.875rem;
  }

  .current-label {
    color: var(--color-gap-text-muted);
    margin-right: 0.5rem;
  }

  .current-value {
    color: var(--color-gap-text);
    font-weight: 500;
  }

  .refine-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .refine-option {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    cursor: pointer;
    padding: 0.875rem 1rem;
    background: var(--color-gap-bg);
    border: 1px solid var(--color-gap-border);
    border-radius: var(--radius-md);
    transition: all 0.2s ease;
  }

  .refine-option:hover {
    border-color: var(--color-gap-accent-light);
  }

  .refine-option:has(input:checked) {
    border-color: var(--color-gap-accent);
    background: rgba(43, 90, 74, 0.05);
  }

  .refine-option input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin-top: 2px;
    accent-color: var(--color-gap-accent);
    cursor: pointer;
    flex-shrink: 0;
  }

  .option-content {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .option-text {
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--color-gap-text);
  }

  .option-hint {
    font-size: 0.8125rem;
    color: var(--color-gap-text-muted);
  }

  .refine-option-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .refine-option-wrapper .refine-option {
    margin-bottom: 0;
  }

  .refine-year-input {
    width: 100%;
    padding: 0.625rem 0.875rem;
    background: var(--color-gap-surface);
    border: 1px solid var(--color-gap-border);
    border-radius: var(--radius-md);
    font-family: var(--font-body);
    font-size: 0.875rem;
    color: var(--color-gap-text);
    transition: all 0.2s ease;
  }

  .refine-year-input:focus {
    outline: none;
    border-color: var(--color-gap-accent);
  }

  .refine-year-input:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  .refine-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--color-gap-border);
    background: var(--color-gap-bg);
    border-radius: 0 0 var(--radius-lg) var(--radius-lg);
  }

  @media (max-width: 640px) {
    .results-header {
      flex-direction: column;
    }

    .results-actions {
      width: 100%;
      justify-content: flex-start;
    }

    .results-summary {
      flex-direction: column;
      gap: 1rem;
    }

    .summary-divider {
      width: 60px;
      height: 1px;
    }

    .tabs-nav {
      justify-content: flex-start;
    }

    .tab-label {
      display: none;
    }

    .tab-btn {
      padding: 0.75rem 1rem;
    }

    .filter-bar {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .filter-count {
      margin-left: 0;
    }

    .refine-dialog {
      max-width: 100%;
    }
  }
</style>

<script>
  let currentResults: any = null;
  let currentParams: any = null;
  let reportUrl: string | null = null;
  let allGaps: any[] = [];
  let filteredGaps: any[] = [];

  // Priority scoring algorithm
  function calculatePriority(gap: any): number {
    const severityScore = gap.severity === 'high' ? 3 : gap.severity === 'medium' ? 2 : 1;
    const paperScore = Math.min((gap.evidence?.paperCount || 0) / 10, 3);
    const noveltyScore = gap.type === 'under-researched-topic' ? 2 : 1;
    return severityScore * 2 + paperScore + noveltyScore;
  }

  function prioritizeGaps(gaps: any[]): any[] {
    return gaps
      .map(gap => ({ ...gap, priority: calculatePriority(gap) }))
      .sort((a, b) => b.priority - a.priority);
  }

  function getPriorityClass(priority: number, index: number): string {
    if (index < 3 && priority > 5) return 'priority-high';
    if (priority > 3) return 'priority-medium';
    return '';
  }

  // Tab switching
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.getAttribute('data-tab');

      // Update active tab button
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Update active panel
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`tab-${tab}`)?.classList.add('active');

      // Show/hide filter bar (only for gaps)
      const filterBar = document.getElementById('filter-bar');
      filterBar?.classList.toggle('visible', tab === 'gaps');
    });
  });

  // Filter and sort handlers
  document.getElementById('filter-severity')?.addEventListener('change', applyFilters);
  document.getElementById('filter-sort')?.addEventListener('change', applyFilters);

  function applyFilters() {
    const severity = (document.getElementById('filter-severity') as HTMLSelectElement)?.value || 'all';
    const sort = (document.getElementById('filter-sort') as HTMLSelectElement)?.value || 'priority';

    filteredGaps = allGaps.filter(gap => {
      if (severity === 'all') return true;
      return gap.severity === severity;
    });

    // Sort
    if (sort === 'priority') {
      filteredGaps = prioritizeGaps(filteredGaps);
    } else if (sort === 'severity') {
      const order = { high: 0, medium: 1, low: 2 };
      filteredGaps.sort((a, b) => (order[a.severity as keyof typeof order] || 2) - (order[b.severity as keyof typeof order] || 2));
    } else if (sort === 'alphabetical') {
      filteredGaps.sort((a, b) => a.title.localeCompare(b.title));
    }

    renderGaps(filteredGaps);
    updateFilterCount();
  }

  function updateFilterCount() {
    const countEl = document.getElementById('filter-count');
    if (countEl) {
      if (filteredGaps.length === allGaps.length) {
        countEl.textContent = `Showing all ${allGaps.length}`;
      } else {
        countEl.textContent = `Showing ${filteredGaps.length} of ${allGaps.length}`;
      }
    }
  }

  // Refine modal handlers
  document.getElementById('refine-btn')?.addEventListener('click', () => {
    document.getElementById('refine-modal')?.classList.add('active');
  });

  document.getElementById('refine-close')?.addEventListener('click', closeRefineModal);
  document.getElementById('refine-cancel')?.addEventListener('click', closeRefineModal);
  document.getElementById('refine-backdrop')?.addEventListener('click', closeRefineModal);

  function closeRefineModal() {
    document.getElementById('refine-modal')?.classList.remove('active');
  }

  // Year filter checkbox enables/disables input
  document.getElementById('refine-year')?.addEventListener('change', (e) => {
    const input = document.getElementById('refine-year-input') as HTMLInputElement;
    if (input) input.disabled = !(e.target as HTMLInputElement).checked;
  });

  // Refine submit (placeholder - would need backend support)
  document.getElementById('refine-submit')?.addEventListener('click', () => {
    // For now, just close and trigger new analysis event
    closeRefineModal();
    document.getElementById('gap-results-container')?.classList.remove('active');
    window.dispatchEvent(new CustomEvent('gapAnalysisReset'));
  });

  // New Analysis button
  document.getElementById('new-analysis-btn')?.addEventListener('click', () => {
    // Reset form and hide results
    document.getElementById('gap-results-container')?.classList.remove('active');
    (document.getElementById('gap-analysis-form') as HTMLFormElement)?.reset();
    const submitBtn = document.getElementById('gap-submit-btn') as HTMLButtonElement;
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.classList.remove('loading');
    }
    window.dispatchEvent(new CustomEvent('gapAnalysisReset'));
  });

  // Download report
  document.getElementById('download-report-btn')?.addEventListener('click', () => {
    if (reportUrl) {
      window.open(reportUrl, '_blank');
    }
  });

  // Render functions
  function renderGaps(gaps: any[]) {
    const gapsList = document.getElementById('gaps-list')!;

    if (gaps.length > 0) {
      gapsList.innerHTML = gaps.map((gap, index) => {
        const severity = gap.severity || 'medium';
        const cardId = `gap-card-${index}`;

        return `
          <div class="gap-card" id="${cardId}">
            <div class="gap-header">
              <div class="gap-title-row">
                <span class="gap-number">${index + 1}.</span>
                <h3 class="gap-title">${gap.title}</h3>
              </div>
              <span class="severity-dot ${severity}" title="${severity} severity"></span>
            </div>
            <p class="gap-description">${gap.description}</p>
            ${gap.suggestedApproach ? `
              <button class="gap-approach-toggle" data-target="${cardId}-approach">
                View suggested approach
              </button>
              <div class="gap-approach collapsed" id="${cardId}-approach">
                ${gap.suggestedApproach}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');

      // Add event listeners for collapsible approach sections
      gapsList.querySelectorAll('.gap-approach-toggle').forEach(btn => {
        btn.addEventListener('click', function() {
          const target = this.getAttribute('data-target');
          const approach = document.getElementById(target!);
          if (approach) {
            const isExpanded = !approach.classList.contains('collapsed');
            approach.classList.toggle('collapsed');
            this.textContent = isExpanded ? 'View suggested approach' : 'Hide suggested approach';
          }
        });
      });
    } else {
      gapsList.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">◇</div>
          <h3 class="empty-title">No gaps match your filters</h3>
          <p class="empty-desc">Try adjusting your filter settings to see more results.</p>
          <button class="empty-btn" onclick="document.getElementById('filter-severity').value='all'; applyFilters();">
            Clear Filters
          </button>
        </div>
      `;
    }
  }

  function renderEmptyGaps() {
    const gapsList = document.getElementById('gaps-list')!;
    gapsList.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">◇</div>
        <h3 class="empty-title">No significant gaps detected</h3>
        <p class="empty-desc">This research area appears well-covered. Consider:</p>
        <ul class="empty-suggestions">
          <li>Try a more specific or niche topic</li>
          <li>Adjust year filter to recent publications</li>
          <li>Run Deep analysis for detailed insights</li>
        </ul>
        <button class="empty-btn" id="empty-retry-btn">Adjust & Retry</button>
      </div>
    `;

    document.getElementById('empty-retry-btn')?.addEventListener('click', () => {
      window.dispatchEvent(new CustomEvent('resetGapForm'));
    });
  }

  // Loading state helpers
  function showLoading() {
    const loading = document.getElementById('gap-results-loading');
    if (loading) loading.style.display = 'flex';
  }

  function hideLoading() {
    const loading = document.getElementById('gap-results-loading');
    if (loading) loading.style.display = 'none';
  }

  // Load and display results
  async function loadResults(resultUrl: string, reportUrlParam?: string, topic?: string) {
    reportUrl = reportUrlParam || null;

    // Show container with loading state
    document.getElementById('gap-progress-container')?.classList.remove('active');
    document.getElementById('gap-results-container')?.classList.add('active');
    showLoading();

    try {
      const response = await fetch(resultUrl);
      if (!response.ok) throw new Error('Failed to load results');

      currentResults = await response.json();
      currentParams = currentResults.params || {};

      // Store topic
      const topicEl = document.getElementById('results-topic');
      if (topicEl && topic) topicEl.textContent = topic;

      // Update current params display
      const paramsEl = document.getElementById('current-params');
      if (paramsEl) {
        const depth = currentParams.depth || 'quick';
        const papers = currentParams.papers || 30;
        paramsEl.textContent = `${papers} papers, ${depth} analysis`;
      }

      displayResults(currentResults);

      // Show filter bar for gaps tab
      document.getElementById('filter-bar')?.classList.add('visible');

      hideLoading();
    } catch (error) {
      console.error('Failed to load results:', error);
      hideLoading();
      // Show error state instead of alert
      document.getElementById('gap-results-container')?.classList.remove('active');
      window.dispatchEvent(new CustomEvent('gapAnalysisError', {
        detail: { error: 'Failed to load analysis results' }
      }));
    }
  }

  function displayResults(data: any) {
    // Update summary
    document.getElementById('summary-papers')!.textContent = data.papers?.length || 0;
    document.getElementById('summary-gaps')!.textContent = data.gaps?.length || 0;
    document.getElementById('summary-directions')!.textContent = data.directions?.length || 0;

    // Update tab counts
    document.getElementById('tab-gaps-count')!.textContent = data.gaps?.length || 0;
    document.getElementById('tab-comparisons-count')!.textContent = data.comparisons?.length || 0;
    document.getElementById('tab-directions-count')!.textContent = data.directions?.length || 0;

    // Store and render gaps with prioritization
    allGaps = data.gaps || [];
    if (allGaps.length > 0) {
      filteredGaps = prioritizeGaps(allGaps);
      renderGaps(filteredGaps);
      updateFilterCount();
    } else {
      renderEmptyGaps();
    }

    // Render comparisons
    const comparisonsList = document.getElementById('comparisons-list')!;
    if (data.comparisons?.length > 0) {
      comparisonsList.innerHTML = data.comparisons.map((comp: any) => `
        <div class="comparison-card">
          <div class="comparison-dimension">Comparison: ${comp.dimension}</div>
          <div class="comparison-findings">
            ${comp.findings.map((f: any) => `
              <div class="finding-group">
                <div class="finding-label">${f.aspect}</div>
                ${f.differences?.length ? `
                  <div class="finding-label" style="margin-top:0.5rem">Differences</div>
                  <ul class="finding-list">
                    ${f.differences.map((d: string) => `<li>${d}</li>`).join('')}
                  </ul>
                ` : ''}
                ${f.similarities?.length ? `
                  <div class="finding-label" style="margin-top:0.5rem">Similarities</div>
                  <ul class="finding-list">
                    ${f.similarities.map((s: string) => `<li>${s}</li>`).join('')}
                  </ul>
                ` : ''}
              </div>
            `).join('')}
          </div>
          ${comp.contradictions?.length ? `
            <div class="finding-group" style="margin-top:0.875rem;background:rgba(155,68,68,0.05)">
              <div class="finding-label" style="color:var(--color-error)">Contradictions</div>
              <ul class="finding-list">
                ${comp.contradictions.map((c: string) => `<li>${c}</li>`).join('')}
              </ul>
            </div>
          ` : ''}
        </div>
      `).join('');
    } else {
      comparisonsList.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">◆</div>
          <h3 class="empty-title">Not enough papers to compare</h3>
          <p class="empty-desc">Methodology comparisons require at least 5 papers with similar focus areas.</p>
          <button class="empty-btn" onclick="window.dispatchEvent(new CustomEvent('resetGapForm'))">
            Analyze More Papers
          </button>
        </div>
      `;
    }

    // Render directions
    const directionsList = document.getElementById('directions-list')!;
    if (data.directions?.length > 0) {
      directionsList.innerHTML = data.directions.map((dir: any) => `
        <div class="direction-card">
          <div class="direction-header">
            <h3 class="direction-title">${dir.title}</h3>
            <div class="direction-ratings">
              <div class="rating">
                <span class="rating-label">Feasibility</span>
                <span class="rating-value ${dir.feasibility}">${dir.feasibility}</span>
              </div>
              <div class="rating">
                <span class="rating-label">Novelty</span>
                <span class="rating-value ${dir.novelty}">${dir.novelty}</span>
              </div>
            </div>
          </div>
          <p class="direction-description">${dir.description}</p>
          ${dir.rationale ? `<p class="direction-rationale">${dir.rationale}</p>` : ''}
        </div>
      `).join('');
    } else {
      directionsList.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">◈</div>
          <h3 class="empty-title">No directions generated</h3>
          <p class="empty-desc">Research directions are generated based on identified gaps. Enable gap detection and try again.</p>
          <button class="empty-btn" onclick="window.dispatchEvent(new CustomEvent('resetGapForm'))">
            Run Full Analysis
          </button>
        </div>
      `;
    }

    // Render trends
    const trendsContent = document.getElementById('trends-content')!;
    if (data.trends) {
      trendsContent.innerHTML = `
        ${data.trends.peakYears?.length ? `
          <div class="trend-card">
            <h4 class="trend-title">Peak Publication Years</h4>
            <div class="trend-tags">
              ${data.trends.peakYears.map((y: string) => `<span class="trend-tag">${y}</span>`).join('')}
            </div>
          </div>
        ` : ''}
        ${data.trends.emergingTopics?.length ? `
          <div class="trend-card">
            <h4 class="trend-title">Emerging Topics</h4>
            <div class="trend-tags">
              ${data.trends.emergingTopics.slice(0, 12).map((t: string) => `<span class="trend-tag">${t}</span>`).join('')}
            </div>
          </div>
        ` : ''}
        ${data.trends.decliningTrends?.length ? `
          <div class="trend-card">
            <h4 class="trend-title">Declining Research Areas</h4>
            <div class="trend-tags">
              ${data.trends.decliningTrends.map((t: string) => `<span class="trend-tag">${t}</span>`).join('')}
            </div>
          </div>
        ` : ''}
      `;

      if (!data.trends.peakYears?.length && !data.trends.emergingTopics?.length && !data.trends.decliningTrends?.length) {
        trendsContent.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">↗</div>
            <h3 class="empty-title">Limited trend data</h3>
            <p class="empty-desc">More papers are needed to identify meaningful publication trends.</p>
          </div>
        `;
      }
    } else {
      trendsContent.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">↗</div>
          <h3 class="empty-title">No trend data available</h3>
          <p class="empty-desc">Trend analysis requires sufficient publication data across multiple years.</p>
        </div>
      `;
    }
  }

  // Listen for analysis completion
  window.addEventListener('gapAnalysisComplete', ((e: CustomEvent) => {
    const { resultUrl, reportUrl } = e.detail;
    // Get topic from progress tracker
    const topic = document.getElementById('progress-topic')?.textContent || '';
    loadResults(resultUrl, reportUrl, topic);
  }) as EventListener);

  // Listen for reset event to clear state
  window.addEventListener('gapAnalysisReset', () => {
    // Reset filter values
    const severitySelect = document.getElementById('filter-severity') as HTMLSelectElement;
    const sortSelect = document.getElementById('filter-sort') as HTMLSelectElement;
    if (severitySelect) severitySelect.value = 'all';
    if (sortSelect) sortSelect.value = 'priority';

    // Reset filter bar visibility
    document.getElementById('filter-bar')?.classList.remove('visible');

    // Reset tab to gaps
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.tab-btn[data-tab="gaps"]')?.classList.add('active');
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('tab-gaps')?.classList.add('active');

    // Clear data
    allGaps = [];
    filteredGaps = [];
    currentResults = null;
    reportUrl = null;

    // Hide results container
    document.getElementById('gap-results-container')?.classList.remove('active');
  });

  // Expose applyFilters globally for inline onclick
  (window as any).applyFilters = applyFilters;
</script>
