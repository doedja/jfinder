---
// ModeToggle - Simple segmented control for switching between Paper Finder and Gap Analysis modes
---

<div class="mode-toggle">
  <button
    class="toggle-option active"
    data-mode="download"
    type="button"
    aria-pressed="true"
  >
    <span class="toggle-icon">↓</span>
    <span class="toggle-label">Paper Finder</span>
  </button>
  <button
    class="toggle-option"
    data-mode="gap"
    type="button"
    aria-pressed="false"
  >
    <span class="toggle-icon">◇</span>
    <span class="toggle-label">Gap Analysis</span>
  </button>
  <div class="toggle-indicator"></div>
</div>

<style>
  .mode-toggle {
    display: inline-flex;
    position: relative;
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: 4px;
    gap: 0;
  }

  .toggle-option {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: transparent;
    border: none;
    border-radius: calc(var(--radius-lg) - 4px);
    font-family: var(--font-body);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: color 0.3s ease;
    white-space: nowrap;
  }

  .toggle-option:hover {
    color: var(--color-text);
  }

  .toggle-option.active {
    color: white;
  }

  .toggle-option[data-mode="download"].active {
    color: white;
  }

  .toggle-option[data-mode="gap"].active {
    color: white;
  }

  .toggle-icon {
    font-size: 1rem;
    transition: transform 0.3s ease;
  }

  .toggle-option:hover .toggle-icon {
    transform: scale(1.1);
  }

  .toggle-indicator {
    position: absolute;
    top: 4px;
    left: 4px;
    height: calc(100% - 8px);
    border-radius: calc(var(--radius-lg) - 4px);
    background: var(--color-accent);
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1),
                background-color 0.4s ease,
                width 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    z-index: 0;
  }

  .toggle-indicator.gap-mode {
    background: var(--color-gap-accent);
  }

  @media (max-width: 480px) {
    .toggle-label {
      display: none;
    }

    .toggle-option {
      padding: 0.625rem 1rem;
    }

    .toggle-icon {
      font-size: 1.125rem;
    }
  }
</style>

<script>
  // Handle all mode toggle instances (there may be multiple on the page)
  document.querySelectorAll('.mode-toggle').forEach(toggle => {
    const indicator = toggle.querySelector('.toggle-indicator') as HTMLElement;
    const options = toggle.querySelectorAll('.toggle-option');

    function updateIndicator() {
      const activeOption = toggle.querySelector('.toggle-option.active') as HTMLElement;
      if (activeOption && indicator) {
        indicator.style.width = `${activeOption.offsetWidth}px`;
        indicator.style.transform = `translateX(${activeOption.offsetLeft - 4}px)`;
      }
    }

    // Initial indicator position
    requestAnimationFrame(updateIndicator);
    window.addEventListener('resize', updateIndicator);

    options.forEach(option => {
      option.addEventListener('click', () => {
        const mode = option.getAttribute('data-mode');

        // Update ALL toggle instances to sync state
        document.querySelectorAll('.mode-toggle').forEach(t => {
          const tOptions = t.querySelectorAll('.toggle-option');
          const tIndicator = t.querySelector('.toggle-indicator');

          tOptions.forEach(opt => {
            opt.classList.remove('active');
            opt.setAttribute('aria-pressed', 'false');
          });

          const targetOpt = t.querySelector(`[data-mode="${mode}"]`);
          targetOpt?.classList.add('active');
          targetOpt?.setAttribute('aria-pressed', 'true');

          // Update indicator color
          if (mode === 'gap') {
            tIndicator?.classList.add('gap-mode');
          } else {
            tIndicator?.classList.remove('gap-mode');
          }
        });

        // Update all indicators
        document.querySelectorAll('.mode-toggle').forEach(t => {
          const ind = t.querySelector('.toggle-indicator') as HTMLElement;
          const activeOpt = t.querySelector('.toggle-option.active') as HTMLElement;
          if (activeOpt && ind) {
            ind.style.width = `${activeOpt.offsetWidth}px`;
            ind.style.transform = `translateX(${activeOpt.offsetLeft - 4}px)`;
          }
        });

        // Dispatch mode change event
        window.dispatchEvent(new CustomEvent('modeChanged', {
          detail: { mode }
        }));
      });
    });

    // Listen for external mode changes
    window.addEventListener('setMode', ((e: CustomEvent) => {
      const { mode } = e.detail;

      // Update all toggle instances
      document.querySelectorAll('.mode-toggle').forEach(t => {
        const tOptions = t.querySelectorAll('.toggle-option');
        const tIndicator = t.querySelector('.toggle-indicator') as HTMLElement;

        tOptions.forEach(opt => {
          opt.classList.remove('active');
          opt.setAttribute('aria-pressed', 'false');
        });

        const targetOpt = t.querySelector(`[data-mode="${mode}"]`);
        targetOpt?.classList.add('active');
        targetOpt?.setAttribute('aria-pressed', 'true');

        if (mode === 'gap') {
          tIndicator?.classList.add('gap-mode');
        } else {
          tIndicator?.classList.remove('gap-mode');
        }

        // Update indicator position
        const activeOpt = t.querySelector('.toggle-option.active') as HTMLElement;
        if (activeOpt && tIndicator) {
          tIndicator.style.width = `${activeOpt.offsetWidth}px`;
          tIndicator.style.transform = `translateX(${activeOpt.offsetLeft - 4}px)`;
        }
      });
    }) as EventListener);
  });
</script>
